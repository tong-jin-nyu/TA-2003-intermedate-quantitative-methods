---
title: "APSTA-GE: 2003 Intermediate Quantitative Methods"
subtitle: "Group Exercise Solution"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    df_print: default
    theme: cosmo
    highlight: haddock
    number_sections: false
---

```{r setup, include=FALSE}
# Created on: 10/12/2020
# Modified on: 10/12/2020
# Author: Tong Jin

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# Dependencies
library(lm.beta)
```

## Description

Reference solutions for the group exercise.

### Data processing

Load lung_capacity0.csv, and add a new column labelling the row ID.

**Answer:**

```{r load}
# Load data
# Add a new column: ID: row number
dat <- read.csv("lung_capacity0.csv")
# Create a new column called "ID" with assignment 1 to the number of rows.
dat$ID <- 1:nrow(dat)
```

<br>

### Question 1

How does lung capacity change as people get older? (in one sentence)

**Answer:**

```{r Q1}
# Compute the correlation between lung capacity and age
cor(dat$LungCapacitycc, dat$Age)
```

The correlation between lung capacity and age is approx. 0.13. The correlation is not strong enough to observe a clear pattern of association.

<br>

#### 1a

Make a scatter plot of lung capacity (on y-axis) and age (on x-axis). 

Eyeball the pattern. What do you see? (in one or two sentences)

**Answer:**

```{r Q1a}
# Create a scatter plot: LungCapacitycc ~ Age
plot(dat$Age, dat$LungCapacitycc)
```

The distribution of lung capacity over age is diverse. We did not observe a clear pattern here.

<br>

#### 1b

Report the sample size.

**Answer:**

```{r Q1b}
nrow(dat)
```

<br>

### Question 2

Conduct a regression analysis to answer the following questions:
	- Which variable is the dependent variable (D.V.)?
	- Which variable is the independent variable (I.V.)?

**Answer:**

```{r Q2}
# Fit a regression model: LungCapacitycc ~ Age
lm_Q2 <- lm(LungCapacitycc ~ Age, data = dat)
summary(lm_Q2)
```

The D.V. is lung capacity. The I.V. is age.

<br>

### Question 3

Answer below questions based on the regression result.

#### 3a 

What’s the regression coefficient of age on lung capacity? 

Report the appropriate regression coefficient and its standard error (S.E.).

**Answer:**

```{r Q3a}
lm_Q2$coefficients

summary(lm_Q2)$coefficients
```

The intercept is 5091.225. The slope is 4.021.

The regression equation, in this case, is:

$$
\text{Lung Capacity} = 5091.225 + 4.021 \times \text{Age}
$$

<br>

#### 3b

Is this coefficient statistically significant? What test did you use?

Write down the null and alternative hypotheses.

Report test statistic and p-value.

**Answer:**

We used hypothesis test. 

**Null**: There is no relationship between people's lung capacity and age.

**Alternative:** There exists a relationship between people's lung capacity and age.

```{r Q3b}
# Report the second row of model coefficients
summary(lm_Q2)$coefficients[2, ]
```

<br>

#### 3c

Report a 95% confidence interval for the regression coefficient of age on lung capacity based on the results from the model.

**Answer:**

```{r Q3c}
confint(lm_Q2)
```

<br>

### Question 4

Based on the model, calculate the fitted values and residuals for all observations in the model. Answer the following questions based on your results.

#### 4a	

What are the mean values of the fitted values and residuals?

**Answer:**

```{r Q4a}
# Calculate the mean value of fitted values
mean(predict(lm_Q2))
# Calculate the mean value of residuals
mean(residuals(lm_Q2))
```

<br>

#### 4b

Calculate or report the total sum of squares (TSS), model sum of squares (MSS) and residual sum of squares (RSS). 

**Verify that:  TSS = MSS + RSS**

**Answer:**

Option 1: manual calculation

```{r Q4b-manual}
# Calculate total sum of squares
TSS <- sum((dat$LungCapacitycc - mean(dat$LungCapacitycc))^2)
# Calculate model sum of squares
MSS <- sum((predict(lm_Q2) - mean(dat$LungCapacitycc))^2)
# Calculate residual sum of squares
RSS <- sum((dat$LungCapacitycc - predict(lm_Q2))^2)

# Check if TSS = MSS + RSS
round(TSS) == round(MSS) + round(RSS)
```

Option 2: use the `anova` function

```{r Q4b}
anova(lm_Q2)
```

Model sum of squares (MSS) = 233,569

Residual sum of squares (RSS) = 14,054,602

Total sum of squares (TSS) = 14,288,171

<br>

#### 4c

What’s the R-square of this model?

**Answer:**

```{r Q4c}
summary(lm_Q2)$r.squared
```

<br>

#### 4d

What’s the correlation between lung capacity and age? 

**Verify that the R-square is the correlation squared.**

**Answer:**

```{r Q4d}
# Report the correlation between lung capacity and age
cor(dat$LungCapacitycc, dat$Age)
# Report R-squared
summary(lm_Q2)$r.squared
# Examine if the squared correlation is equal to r-squared
round(cor(dat$LungCapacitycc, dat$Age)^2) == round(summary(lm_Q2)$r.squared)
```

<br>

### Question 5

Based on this model, how much difference do we expect to see between 20 years old and 25 year old? And between 60 years old and 65 years old?

**Hint:** By the nature of linear relationships, it doesn’t matter at what age ranges. This Model assumes that 1 year age difference leads to the same change in lung capacity.

**Answer:**

```{r Q5}
# Create new dataset and store independent variables for prediction
new_dat <- data.frame(Age = c(20, 25, 60, 65))
# Predict lung capacity using the new dataset
predict(lm_Q2, newdata = new_dat)
# Difference between 20 and 25 years old
predict(lm_Q2, newdata = new_dat)[2] - predict(lm_Q2, newdata = new_dat)[1]
# Difference between 60 and 65 years old
predict(lm_Q2, newdata = new_dat)[4] - predict(lm_Q2, newdata = new_dat)[3]
```

<br>

Another interesting question:

Can you prescribe a 95% confidence interval for the average difference in lung capacity associated with a 5-year age difference? 

**Hint:** 
  $\beta_1$ is the difference due to 1-year difference in age.
	$5 * \beta_1$ is the difference due to a 5-years difference in age. 
		
**Answer:**

```{r Q5-2}
# Calculate: slope * 5
summary(lm_Q2)$coefficients[2, "Estimate"] * 5
```

<br>

Now the standard error in $\hat{\beta_1}$ is ___?

**Answer:**

```{r Q5-3}
# Get the standard error for the slope
summary(lm_Q2)$coefficients[2, "Std. Error"]
```

What’s the standard error in $5 \times \beta_1$? It is 5 $S.E.$. 

**Answer:**

$$
SE_{5 \times \beta_1} = 5 \times SE_{\beta_1}
$$

```{r Q5-4}
# Get the standard error for 5 * slope
summary(lm_Q2)$coefficients[2, "Std. Error"] * 5
```

```{r Q5-5}
# Calculate the confidence interval for 5 * slope
slope_Q5 <- summary(lm_Q2)$coefficients[2, "Estimate"] * 5
se_Q5 <- summary(lm_Q2)$coefficients[2, "Std. Error"] * 5
slope_Q5 - 2 * se_Q5
slope_Q5 + 2 * se_Q5

# Validate with: 5 * CL(beta_1)
5 * confint(lm_Q2)["Age", ]
```

<br>

### Question 6

Estimate standardized regression coefficients using two different approaches.

#### 6a

Generate a new variable based on lung capacity by dividing its original value by its standard deviation.

**Answer:**

```{r Q6a}
dat$std_lungCap <- dat$LungCapacitycc / sd(dat$LungCapacitycc)
```

Generate a new variable based on age by dividing its original value by its standard deviation. 
Run a regression using these two new variables. Report the regression coefficients (intercept and slope)

**Answer:**

```{r Q6a-2}
dat$std_age <- dat$Age / sd(dat$Age)

# Fit a new regression model
lm_Q6 <- lm(std_lungCap ~ std_age, data = dat)
# Report coefficients
lm_Q6$coefficients
```

<br>

#### 6b

Use lm.beta to estimate the standardized regression coefficients.

**Answer:**

```{r Q6b}
lm.beta(lm_Q2)
```

<br>

#### 6c

Compare standardized slope with correlation.

**Answer:**

```{r Q6c}
# Standardized slope
lm_Q6$coefficients["std_age"]
# Correlation
cor(dat$LungCapacitycc, dat$Age)
```

Standardized slope is equal to correlation.

<br>

#### 6d

What is the meaning of the intercept now?

By standardization, we are able to compare the relationship between two variables which originally have different measurement units. In this case, lung capacity is measured in `cc` while age is measured in `year`.

<br>

### Question 7C

Conduct regression diagnostics.

**Hint:** R: stat package (more traditional) - influence.measures function
          
          R: car (fancier plots)
          
Regression Diagnostics

#### 7a

Plot a studentized residual plot against Y (fitted values).

**Answer:**

```{r Q7a}
# Calculate studentized residuals
x <- residuals(lm_Q2) / sd(residuals(lm_Q2))
# Plot studentized residual plot against Y (fitted values)
plot(x = x, y = dat$LungCapacitycc)
```

<br>

How is figure the same or different from:

Residual versus Y?

**Answer:**

```{r Q7a-2}
# Plot residuals against Y
plot(x = residuals(lm_Q2), y = dat$LungCapacitycc)
```

The difference between the residual plot and studentized residual plot is the measurement unit on x-axis. The residual plot uses `cc` as the measurement unit while the studentized residual plot uses `standard deviation` of residuals as the measurement unit.

<br>

How is figure the same or different from:

Residual (or studentized residual) versus age?

**Answer:**

```{r Q7a-3}
# Plot residuals against age
plot(x = residuals(lm_Q2), y = dat$Age)
```

The difference between the residual plot versus `Y` and the residual plot versus `Age` is the variable on the y-axis. 

<br>

Difference between standardized and studentized residuals?

**Answer:**

```{r Q7a-4}

```

Any outliers? Use -2 and 2 as fences.
Based on eyeballing, does linear relationship hold?
Test linearity by including a quadratic term.
Based on eyeballing, does equal variance hold?
Test for equal variance.
Any observations have leverage, and high influence?
Eyeball by overlaying the fitted line - outliers along x and y axes?
Use a fancy plot.
Use Cook’s D, Deffits.
Remove outlier data points, what happens? Things to check:
p-value of 1, difference in values of new and old 1 estimates.
SE values of new and old 1 estimates.
R squares of the new and old models.
Remove influential data points, what happens?
For curious minds, if we remove data points that have high leverage but not an outlier or influential, what will happen? 
Can you fabricate some points to test the ideas? 
Hint: you can add a new observation with a pair of lung capacity and age values of your choice and attach this new row to the existing data.
Lastly, think about when should we remove point(s) and when should we not remove point(s) from regression? What are the pros and cons?  

